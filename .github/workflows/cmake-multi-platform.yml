name: CMake on Multiple Platforms

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up CMake
        uses: jwlawson/actions-setup-cmake@v2

      - name: Install dependencies on Ubuntu
        if: matrix.os == 'ubuntu-latest'
        run: sudo apt-get install -y build-essential cmake libgtest-dev

      - name: Install GTest on Ubuntu
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get install -y libgtest-dev
          cd /usr/src/googletest/googletest
          sudo cmake CMakeLists.txt
          sudo make
          sudo cp lib/*.a /usr/lib

      - name: Install dependencies on macOS
        if: matrix.os == 'macos-latest'
        run: |
          brew install --formula cmake
          brew install googletest

      - name: Install dependencies on Windows
        if: matrix.os == 'windows-latest'
        run: |
          choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System'
          # Alternative installation for googletest if not found on Chocolatey
          if (!(choco list --local-only | Select-String -Pattern "googletest")) {
            Write-Host "googletest not found in Chocolatey. Installing manually..."
            Invoke-WebRequest -Uri "https://github.com/google/googletest/archive/refs/heads/main.zip" -OutFile "googletest-main.zip"
            Expand-Archive -Path "googletest-main.zip" -DestinationPath "."
            # Renomear a pasta para o nome esperado
            Rename-Item -Path "googletest-main" -NewName "googletest-release-1.15.2"
            cd "googletest-release-1.15.2"
            cmake -S . -B build
            cmake --build build --target install
          }

      - name: Configure CMake
        run: cmake -B build -S .

      - name: Build project
        run: cmake --build build

      - name: Run tests
        run: ctest --test-dir build
